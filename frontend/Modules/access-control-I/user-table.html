<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIGRA | Gestión de Usuarios</title>
  <link rel="stylesheet" href="user-table.css" />
</head>

<body>
  <!-- Navbar superior -->
  <header>
    <nav class="navbar" aria-label="Barra de navegación principal">
      <a class="brand" aria-label="SIGRA" href="user-table.html">
        <img class="brand-logo" src="../../Public/resources/Modulo-1/logo.png" alt="Logo SIGRA" />
        <span>SIGRA</span>
      </a>

      <div class="nav-links" role="list">
        <a class="active" href="user-table.html" role="listitem">Inicio</a>
        <a href="registro.html" role="listitem">Crear Usuario</a>
        <a href="../academic-structure-II/catalogo-materias/index.html" role="listitem">Catalogo</a>
        <a href="../academic-structure-II/gestion-materias/index.html" role="listitem">Materias</a>
        <a href="../academic-structure-II/gestion-horarios/index.html" role="listitem">Horarios</a>
        <a href="../academic-structure-II/definicion-prelaciones/index.html" role="listitem">Prelaciones</a>
        <a href="../academic-structure-II/Gestionar Asignaciones/index.html" role="listitem"> Inscripción</a>
        <a href="../academic-structure-II/Gestionar Asignaciones/gestionar-asignacion.html"
          role="listitem">Asignacion</a>
      </div>

      <div class="profile-menu" aria-label="Menú de perfil">
        <button class="profile-button" id="profile-button" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="profile-avatar" id="profile-avatar" aria-hidden="true">--</span>
          <span class="sr-only">Abrir menú de perfil</span>
        </button>
        <div class="profile-dropdown" id="profile-dropdown" role="menu">
          <ul class="profile-list" role="menu">
            <li class="profile-info" id="profile-info-name" role="presentation">Usuario</li>
            
            <li role="none"><button type="button" class="profile-item" data-profile-action="view" role="menuitem">Ver usuario</button></li>
            <li role="none"><button type="button" class="profile-item" data-profile-action="edit" role="menuitem">Editar usuario</button></li>
            <li role="none"><button type="button" class="profile-item" data-profile-action="logout"
                role="menuitem">Cerrar sesión</button></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Contenido principal -->
  <main>
    <div class="page-header">
      <h1>Dashboard de usuarios</h1>
      <p class="subtitle">Administra y supervisa la actividad de los usuarios en el sistema.</p>
    </div>

    <div class="toolbar">
      <div class="filters">
        <div class="filter-group">
          <label for="user-filter">Filtrar</label>
          <input id="user-filter" type="text" placeholder="Buscar por nombre, correo o cédula" />
        </div>
        <div class="filter-group">
          <label for="role-filter">Rol</label>
          <select id="role-filter">
            <option value="">Todos</option>
            <option value="1">Administrador</option>
            <option value="2">Docente</option>
            <option value="3">Estudiante</option>
            <option value="4">Control de Estudios</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <section class="table-card" aria-label="Tabla de usuarios">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th scope="col">Usuario</th>
              <th scope="col">Cédula</th>
              <th scope="col">Rol</th>
              <th scope="col">Estado</th>
              <th scope="col">Correo</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody id="users-body">
            <tr id="users-loading">
              <td colspan="6">Cargando usuarios...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" aria-label="Paginación de usuarios">
        <div id="pagination" class="pagination-content"></div>
      </div>
    </section>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE = 'http://localhost:5200/api/auth'
      const tbody = document.getElementById('users-body')
      const loadingRow = document.getElementById('users-loading')
      const profileBtn = document.getElementById('profile-button')
      const profileDropdown = document.getElementById('profile-dropdown')
      const profileAvatar = document.getElementById('profile-avatar')
      const profileInfoName = document.getElementById('profile-info-name')
      const paginationEl = document.getElementById('pagination')
      const roleFilter = document.getElementById('role-filter')
      const PAGE_SIZE = 8

      const ROLE_LABELS = {
        1: 'Administrador',
        2: 'Docente',
        3: 'Estudiante',
        4: 'Control de Estudios'
      }

      function badge(isActive) {
        const active = Boolean(isActive)
        const cls = active ? 'badge active' : 'badge inactive'
        const text = active ? 'Activo' : 'Inactivo'
        return `<span class="${cls}">${text}</span>`
      }

      function ensureRoleOption(selectEl, roleId) {
        if (!selectEl || roleId === undefined || roleId === null) return
        const roleValue = String(roleId)
        const exists = Array.from(selectEl.options).some((opt) => opt.value === roleValue)
        if (!exists) {
          const opt = document.createElement('option')
          opt.value = roleValue
          opt.textContent = ROLE_LABELS[roleId] || `Rol ${roleValue}`
          if (roleValue === '1') opt.disabled = true // Admin solo lectura
          selectEl.appendChild(opt)
        }
      }

      function actionButtonsFactory() {
        const loggedUser = getStoredUser() || {}
        const loggedId = loggedUser.id || loggedUser.user_id
        const loggedRoleId = getLoggedRoleId()

        return (user) => {
          const roleId = Number(user.role_id)
          const isAdminRow = roleId === 1
          const isSelf = loggedId && Number(user.user_id) === Number(loggedId)
          const isActiveRow = Boolean(user.is_active ?? true)
          const isControlUser = loggedRoleId === 4
          const isTeacherRow = roleId === 2

          const encodedUser = encodeURIComponent(JSON.stringify(user))

          const viewBtn = `
                <button class="icon-link" type="button" data-action="view" data-user="${encodedUser}" aria-label="Ver usuario">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6" />
                  </svg>
                </button>`

          const editBtn = `
                <button class="icon-link" type="button" data-action="edit" data-user="${encodedUser}" aria-label="Editar usuario">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M4 20h4l9.5-9.5a1.5 1.5 0 0 0 0-2.12l-1.88-1.88a1.5 1.5 0 0 0-2.12 0L4 16v4Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" />
                    <path d="M13.5 6.5 17.5 10.5" stroke="currentColor" stroke-width="1.6" />
                  </svg>
                </button>`

          const toggleBtn = `
                <button class="icon-link ${isActiveRow ? 'danger' : ''}" type="button" data-action="toggle" data-user="${encodedUser}" aria-label="${isActiveRow ? 'Desactivar usuario' : 'Activar usuario'}">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M12 3v10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <path d="M5.5 6.5a8.5 8.5 0 1 0 13 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>`

          if (isAdminRow) {
            if (isSelf) return `${viewBtn} ${editBtn}`
            return viewBtn
          }

          // Control de Estudios: profesores solo se pueden ver (sin editar ni activar/desactivar)
          if (isControlUser && isTeacherRow) {
            return viewBtn
          }

          return `${viewBtn} ${editBtn} ${toggleBtn}`
        }
      }

      function renderPagination(totalPages) {
        if (!paginationEl) return
        if (totalPages <= 1) {
          paginationEl.innerHTML = ''
          return
        }

        const prevDisabled = currentPage === 1 ? 'disabled' : ''
        const nextDisabled = currentPage === totalPages ? 'disabled' : ''

        const visible = new Set([1, totalPages])
        for (let offset = -2; offset <= 2; offset += 1) {
          const page = currentPage + offset
          if (page > 1 && page < totalPages) visible.add(page)
        }

        const pages = Array.from(visible).sort((a, b) => a - b)

        const parts = []
        parts.push(`<button class="page-item icon" type="button" data-page="${currentPage - 1}" aria-label="Página anterior" ${prevDisabled}>‹</button>`)

        for (let i = 0; i < pages.length; i += 1) {
          const page = pages[i]
          const prevPage = pages[i - 1]
          if (prevPage && page - prevPage > 1) {
            parts.push('<span class="page-ellipsis">…</span>')
          }
          const active = page === currentPage ? 'active' : ''
          const aria = page === currentPage ? 'aria-current="page"' : ''
          parts.push(`<button class="page-item ${active}" type="button" data-page="${page}" ${aria}>${page}</button>`)
        }

        parts.push(`<button class="page-item icon" type="button" data-page="${currentPage + 1}" aria-label="Página siguiente" ${nextDisabled}>›</button>`)

        paginationEl.innerHTML = parts.join('')
      }

      function renderUsers(users = []) {
        const actionButtons = actionButtonsFactory()

        if (!users.length) {
          tbody.innerHTML = '<tr><td colspan="6">No hay usuarios registrados.</td></tr>'
          renderPagination(0)
          return
        }

        const totalPages = Math.max(1, Math.ceil(users.length / PAGE_SIZE))
        if (currentPage > totalPages) currentPage = totalPages
        const start = (currentPage - 1) * PAGE_SIZE
        const pageUsers = users.slice(start, start + PAGE_SIZE)

        const rows = pageUsers.map((user) => {
          const roleId = Number(user.role_id)
          const role = ROLE_LABELS[roleId] || `Rol ${roleId || 'N/D'}`
          const nationalId = user.national_id || 'Sin cédula'
          const name = [user.first_name, user.last_name].filter(Boolean).join(' ').trim() || 'Sin nombre'
          const email = user.email || 'Sin correo'
          const isActive = user.is_active ?? true

          return `
            <tr>
              <td>${name}</td>
              <td>${nationalId}</td>
              <td>${role}</td>
              <td>${badge(isActive)}</td>
              <td>${email}</td>
              <td class="actions-cell">
                ${actionButtons(user)}
              </td>
            </tr>
          `
        })

        tbody.innerHTML = rows.join('')
        renderPagination(totalPages)
      }

      function getDisplayName(user) {
        const name = [user.first_name, user.last_name].filter(Boolean).join(' ').trim()
        return name || user.email || `Usuario #${user.user_id}`
      }

      async function toggleUserActive(user) {
        const loggedRoleId = getLoggedRoleId()
        if (loggedRoleId === 4 && Number(user.role_id) === 2) {
          return
        }
        const nombre = getDisplayName(user)
        const nextState = !Boolean(user.is_active)
        const question = nextState ? `¿Activar a "${nombre}"?` : `¿Desactivar a "${nombre}"?`
        const ok = window.confirm(question)
        if (!ok) return
        try {
          const response = await fetch(`${API_BASE}/update/${user.user_id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders()
            },
            body: JSON.stringify({ is_active: nextState })
          })
          if (!response.ok) {
            const err = await response.json().catch(() => ({}))
            throw new Error(err.error || 'No se pudo actualizar el estado del usuario')
          }
          await loadUsers()
        } catch (error) {
          alert(error.message)
          console.error('Error cambiando estado de usuario:', error)
        }
      }

      function attachActions() {
        tbody.addEventListener('click', (event) => {
          const btn = event.target.closest('button[data-action]')
          if (!btn) return
          const action = btn.dataset.action
          const user = JSON.parse(decodeURIComponent(btn.dataset.user || '%7B%7D'))
          if (action === 'toggle') {
            toggleUserActive(user)
            return
          }
          openModal(user, action)
        })
      }

      let allUsers = []
      let filteredUsers = []
      let currentPage = 1
      let currentUser = null

      function getAuthHeaders() {
        const token = localStorage.getItem('sigra_token') || ''
        return token ? { Authorization: `Bearer ${token}` } : {}
      }

      function getStoredUser() {
        const raw = localStorage.getItem('sigra_user')
        if (!raw) return null
        try {
          return JSON.parse(raw)
        } catch (_) {
          return null
        }
      }

      function getLoggedRoleId() {
        const u = getStoredUser() || {}
        const rid = u.role_id ?? (u.role && u.role.role_id)
        return Number(rid) || null
      }

      function clearSessionStorage() {
        localStorage.removeItem('sigra_token')
        localStorage.removeItem('sigra_user')
        localStorage.removeItem('sigra_user_raw')
      }

      async function logoutUser() {
        const stored = getStoredUser()
        const userId = stored?.id || stored?.user_id
        try {
          if (userId) {
            const response = await fetch(`${API_BASE}/logout/${userId}`, {
              method: 'POST',
              headers: { ...getAuthHeaders() }
            })

            if (!response.ok) {
              const err = await response.json().catch(() => ({}))
              console.warn('No se pudo cerrar sesión en el backend:', err.error || response.statusText)
            }
          }
        } catch (error) {
          console.error('Error llamando a logout en backend:', error)
        } finally {
          clearSessionStorage()
          window.location.href = './login.html'
        }
      }

      function setProfileUI() {
        const user = getStoredUser()
        const name = user ? `${user.first_name || ''} ${user.last_name || ''}`.trim() : ''
        const initials = name
          ? name
            .split(' ')
            .filter(Boolean)
            .slice(0, 2)
            .map((part) => part[0].toUpperCase())
            .join('')
          : '--'
        if (profileAvatar) profileAvatar.textContent = initials || '--'
        if (profileInfoName) profileInfoName.textContent = name || 'Usuario'
      }

      function applyFilter() {
        const term = (document.getElementById('user-filter').value || '').toLowerCase()
        const selectedRole = (roleFilter?.value || '').trim()
        filteredUsers = allUsers.filter((u) => {
          const name = `${u.first_name || ''} ${u.last_name || ''}`.toLowerCase()
          const email = (u.email || '').toLowerCase()
          const nationalId = String(u.national_id || '').toLowerCase()
          const matchesTerm = name.includes(term) || email.includes(term) || nationalId.includes(term)
          const matchesRole = !selectedRole || String(u.role_id) === selectedRole
          return matchesTerm && matchesRole
        })
        currentPage = 1
        renderUsers(filteredUsers)
      }

      async function loadUsers() {
        try {
          const response = await fetch(`${API_BASE}/users`)
          if (!response.ok) throw new Error('No se pudo obtener usuarios')
          const data = await response.json()
          const loggedRoleId = getLoggedRoleId()
          let list = data.users || []
          if (loggedRoleId === 4) {
            list = list.filter((u) => {
              const r = Number(u.role_id)
              return r === 2 || r === 3
            })
            // Limitar opciones del filtro de rol para este perfil
            if (roleFilter) {
              Array.from(roleFilter.options).forEach((opt) => {
                if (!opt.value) return
                if (opt.value !== '2' && opt.value !== '3') opt.hidden = true
              })
              // Si estaba seleccionado un rol no permitido, resetear a Todos
              if (roleFilter.value && roleFilter.value !== '2' && roleFilter.value !== '3') {
                roleFilter.value = ''
              }
            }
          }
          allUsers = list
          filteredUsers = allUsers
          currentPage = 1
          console.log('Usuarios cargados:', allUsers)
          renderUsers(filteredUsers)
        } catch (error) {
          tbody.innerHTML = `<tr><td colspan="6">${error.message}</td></tr>`
          console.error('Error cargando usuarios:', error)
        } finally {
          if (loadingRow) loadingRow.remove()
        }
      }
      console.log(allUsers)

      function openModal(user, mode = 'view') {
        const loggedRoleId = getLoggedRoleId()
        const userRoleId = Number(user.role_id)
        // Control de Estudios no puede editar profesores; forzar solo vista
        if (loggedRoleId === 4 && userRoleId === 2 && mode === 'edit') {
          mode = 'view'
        }
        const modal = document.getElementById('user-modal')
        const overlay = document.getElementById('user-modal-overlay')
        const title = document.getElementById('user-modal-title')
        const fields = ['first_name', 'last_name', 'national_id', 'email', 'phone', 'role_id', 'is_active']

        currentUser = user

        title.textContent = mode === 'edit' ? 'Editar usuario' : 'Ver usuario'

        fields.forEach((field) => {
          const input = document.getElementById(`modal-${field}`)
          if (!input) return
          const value = user[field]
          if (input.type === 'checkbox') {
            input.checked = Boolean(value ?? true)
            input.disabled = mode === 'view'
          } else if (input.tagName === 'SELECT') {
            ensureRoleOption(input, value)
            input.value = value ?? ''
            const isAdmin = Number(value) === 1
            const lockRoleChange = mode === 'edit' // No permitir cambiar entre profesor/estudiante al editar
            input.disabled = mode === 'view' || isAdmin || lockRoleChange
          } else {
            input.value = value ?? ''
            input.disabled = mode === 'view'
          }
        })

        // Mostrar inputs de representante solo para estudiantes
        const isStudent = Number(user.role_id) === 3
        // Ocultar bloque antiguo si existe (evitar duplicados)
        const oldRepWrap = document.getElementById('representative-fields')
        if (oldRepWrap) oldRepWrap.style.display = 'none'

        const repWrap = document.getElementById('representative-inline-fields')
        const repNationalTop = document.getElementById('modal-parents_national_id-top')
        const repFirstTop = document.getElementById('modal-parents_first_name-top')
        const repLastTop = document.getElementById('modal-parents_last_name-top')

        if (repWrap && repNationalTop && repFirstTop && repLastTop) {
          if (isStudent) {
            repWrap.style.display = 'block'
            repNationalTop.value = user.parents_national_id ?? ''
            repFirstTop.value = user.parents_first_name ?? ''
            repLastTop.value = user.parents_last_name ?? ''
            const disabled = (mode === 'view')
            repNationalTop.disabled = disabled
            repFirstTop.disabled = disabled
            repLastTop.disabled = disabled
          } else {
            repWrap.style.display = 'none'
            repNationalTop.value = ''
            repFirstTop.value = ''
            repLastTop.value = ''
          }
        }
        
        // La contraseña no se prellena por seguridad; habilitada solo en edición
        const pwdInput = document.getElementById('modal-password')
        if (pwdInput) {
          pwdInput.value = ''
          pwdInput.disabled = mode === 'view'
        }

        // Confirmar contraseña también debe estar deshabilitado en modo 'ver'
        const confirmPwdInput = document.getElementById('modal-confirm-password')
        if (confirmPwdInput) {
          confirmPwdInput.value = ''
          confirmPwdInput.disabled = mode === 'view'
        }

        modal.dataset.mode = mode
        modal.classList.add('open')
        overlay.classList.add('open')
      }

      function closeModal() {
        document.getElementById('user-modal').classList.remove('open')
        document.getElementById('user-modal-overlay').classList.remove('open')
      }

      async function saveUser() {
        const modal = document.getElementById('user-modal')
        if (modal.dataset.mode !== 'edit' || !currentUser?.user_id) {
          closeModal()
          return
        }

        const selectedRoleId = Number(document.getElementById('modal-role_id').value) || currentUser.role_id

        const payload = {
          first_name: document.getElementById('modal-first_name').value.trim(),
          last_name: document.getElementById('modal-last_name').value.trim(),
          national_id: document.getElementById('modal-national_id').value.trim(),
          email: document.getElementById('modal-email').value.trim(),
          phone: document.getElementById('modal-phone').value.trim(),
          role_id: selectedRoleId,
          is_active: document.getElementById('modal-is_active').checked
        }

        // Tomar campos del representante (solo relevantes para estudiantes)
        const repNationalTop = document.getElementById('modal-parents_national_id-top')
        const repFirstTop = document.getElementById('modal-parents_first_name-top')
        const repLastTop = document.getElementById('modal-parents_last_name-top')
        const repNationalVal = (repNationalTop?.value || '').trim()
        const repFirstVal = (repFirstTop?.value || '').trim()
        const repLastVal = (repLastTop?.value || '').trim()

        if (selectedRoleId === 3) {
          payload.parents_national_id = repNationalVal || ''
          payload.parents_first_name = repFirstVal || ''
          payload.parents_last_name = repLastVal || ''
        } else {
          // Si deja de ser estudiante, limpiar campos en backend
          payload.parents_national_id = null
          payload.parents_first_name = null
          payload.parents_last_name = null
        }

        const newPassword = (document.getElementById('modal-password')?.value || '').trim()
        const confirmPassword = (document.getElementById('modal-confirm-password')?.value || '').trim()
        if (newPassword) {
          if (!confirmPassword) {
            alert('Confirma la contraseña.')
            return
          }
          if (newPassword !== confirmPassword) {
            alert('Las contraseñas no coinciden.')
            return
          }
          if (newPassword.length < 8 || newPassword.length > 20) {
            alert('La contraseña debe tener entre 8 y 20 caracteres.')
            return
          }
          const pwdRegex = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[-_+\*\/\?]).+$/
          if (!pwdRegex.test(newPassword)) {
            alert('La contraseña debe contener al menos: una letra mayúscula, una letra minúscula, un número y uno de los caracteres permitidos: - _ + * / ?')
            return
          }
          payload.password_hash = newPassword
        }

        // Detectar cambios respecto al usuario actual
        const changed = (
          payload.first_name !== (currentUser.first_name || '') ||
          payload.last_name !== (currentUser.last_name || '') ||
          payload.national_id !== (currentUser.national_id || '') ||
          payload.email !== (currentUser.email || '') ||
          payload.phone !== (currentUser.phone || '') ||
          Number(payload.role_id) !== Number(currentUser.role_id) ||
          Boolean(payload.is_active) !== Boolean(currentUser.is_active) ||
          // Cambios en datos del representante
          (Number(payload.role_id) === 3 && (
            (payload.parents_national_id || '') !== (currentUser.parents_national_id || '') ||
            (payload.parents_first_name || '') !== (currentUser.parents_first_name || '') ||
            (payload.parents_last_name || '') !== (currentUser.parents_last_name || '')
          )) ||
          // Si deja de ser estudiante y tenía datos de representante, también cuenta como cambio
          (Number(currentUser.role_id) === 3 && Number(payload.role_id) !== 3 && (
            (currentUser.parents_national_id || '') !== '' ||
            (currentUser.parents_first_name || '') !== '' ||
            (currentUser.parents_last_name || '') !== ''
          )) ||
          Boolean(newPassword)
        )

        if (!changed) {
          alert('No hay cambios para guardar.')
          return
        }

        const ok = window.confirm('¿Estas seguro que quieres modificar este usuario?')
        if (!ok) return

        try {
          const response = await fetch(`${API_BASE}/update/${currentUser.user_id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders()
            },
            body: JSON.stringify(payload)
          })

          if (!response.ok) {
            const err = await response.json().catch(() => ({}))
            throw new Error(err.error || 'No se pudo actualizar el usuario')
          }

          await loadUsers()
          closeModal()
        } catch (error) {
          alert(error.message)
          console.error('Error al actualizar usuario:', error)
        }
      }

      // Filtra la tabla en vivo al escribir en el buscador.
      document.getElementById('user-filter').addEventListener('input', applyFilter)
      if (roleFilter) {
        roleFilter.addEventListener('change', applyFilter)
      }
      document.getElementById('modal-close').addEventListener('click', closeModal)
      document.getElementById('user-modal-overlay').addEventListener('click', closeModal)
      document.getElementById('modal-save').addEventListener('click', saveUser)

      const addUserBtn = document.getElementById('add-user-btn')
      const profileCreateItem = document.querySelector('[data-profile-action="create"]')
      const loggedRoleIdInit = getLoggedRoleId()
      if (loggedRoleIdInit === 4) {
        if (addUserBtn) addUserBtn.style.display = 'none'
        if (profileCreateItem) profileCreateItem.style.display = 'none'

        // Ajustar navbar para rol Control de Estudios (id = 4)
        const navLinks = document.querySelector('.nav-links')
        if (navLinks) {
          const links = [
            '<a class="active" href="user-table.html" role="listitem">Inicio</a>',
            '<a href="../academic-structure-II/catalogo-materias/index.html" role="listitem">Catalogo</a>',
            '<a href="../academic-structure-II/gestion-materias/index.html" role="listitem">Materias</a>',
            '<a href="../academic-structure-II/definicion-prelaciones/index.html" role="listitem">Prelaciones</a>',
            '<a href="../academic-structure-II/gestion-horarios/index.html" role="listitem">Horarios</a>',
            '<a href="../academic-structure-II/Gestionar Asignaciones/index.html" role="listitem">Inscripción</a>',
            '<a href="../academic-structure-II/Gestionar Asignaciones/gestionar-asignacion.html" role="listitem">Gestionar Asignación</a>'
          ]
          navLinks.innerHTML = links.join('')
        }
      }
      if (addUserBtn) {
        addUserBtn.addEventListener('click', () => {
          window.location.href = './registro.html'
        })
      }

      function toggleProfileDropdown(forceState) {
        const isOpen = profileDropdown.classList.contains('open')
        const nextState = forceState !== undefined ? forceState : !isOpen
        profileDropdown.classList.toggle('open', nextState)
        profileBtn.setAttribute('aria-expanded', nextState ? 'true' : 'false')
      }

      async function handleProfileAction(action) {
        if (action === 'logout') {
          await logoutUser()
          return
        }

        if (action === 'create') {
          if (getLoggedRoleId() === 4) return
          window.location.href = './registro.html'
          return
        }

        if (action === 'view') {
          const stored = getStoredUser()
          if (stored) {
            openModal(stored, 'view')
          }
          return
        }

        if (action === 'edit') {
          const stored = getStoredUser()
          if (stored) {
            openModal(stored, 'edit')
          }
        }
      }

      if (profileBtn) {
        profileBtn.addEventListener('click', () => toggleProfileDropdown())
      }

      document.addEventListener('click', (evt) => {
        if (!profileDropdown.contains(evt.target) && !profileBtn.contains(evt.target)) {
          toggleProfileDropdown(false)
        }
      })

      if (paginationEl) {
        paginationEl.addEventListener('click', (evt) => {
          const btn = evt.target.closest('[data-page]')
          if (!btn || btn.disabled) return
          const page = Number(btn.dataset.page)
          if (Number.isNaN(page)) return

          const totalPages = Math.max(1, Math.ceil((filteredUsers || []).length / PAGE_SIZE))
          const nextPage = Math.min(Math.max(page, 1), totalPages)
          if (nextPage === currentPage) return
          currentPage = nextPage
          renderUsers(filteredUsers)
        })
      }

      profileDropdown.addEventListener('click', (evt) => {
        const item = evt.target.closest('[data-profile-action]')
        if (!item) return
        const action = item.dataset.profileAction
        handleProfileAction(action)
        toggleProfileDropdown(false)
      })

      attachActions()
      setProfileUI()
      loadUsers()
    })
  </script>

  <div id="user-modal-overlay" class="modal-overlay"></div>
  <div id="user-modal" class="modal" style="max-width: 420px; min-width: 320px; width: 90vw; max-height: 80vh; overflow-y: auto;">
    <div class="modal-header">
      <h2 id="user-modal-title">Detalle de usuario</h2>
      <button id="modal-close" type="button" aria-label="Cerrar" class="icon-link">✕</button>
    </div>
    <div class="modal-body">
      <label>
        Nombre
        <input id="modal-first_name" type="text" />
      </label>
      <label>
        Apellido
        <input id="modal-last_name" type="text" />
      </label>
      <label>
        Cédula
        <input id="modal-national_id" type="text" inputmode="numeric" />
      </label>
      <label>
        Correo
        <input id="modal-email" type="email" />
      </label>
      <div id="representative-inline-fields" style="display:none; margin-top: 8px;">
        <label>
          Cédula del representante
          <input id="modal-parents_national_id-top" type="text" inputmode="numeric" />
        </label>
        <label>
          Nombre del representante
          <input id="modal-parents_first_name-top" type="text" />
        </label>
        <label>
          Apellido del representante
          <input id="modal-parents_last_name-top" type="text" />
        </label>
      </div>
      <label>
        Contraseña (opcional)
        <input id="modal-password" type="password" placeholder="Dejar en blanco para no cambiar" autocomplete="new-password" />
      </label>
      <label>
        Confirmar Contraseña
        <input id="modal-confirm-password" type="password" placeholder="Repite la contraseña" autocomplete="new-password" />
      </label>
      <label>
        Teléfono
        <input id="modal-phone" type="tel" />
      </label>
      <label>
        Rol
        <select id="modal-role_id">
          <option value="2">Profesor</option>
          <option value="3">Estudiante</option>
          <option value="4">Control de Estudios</option>
          <option value="1" disabled>Administrador (solo lectura)</option>
        </select>
      </label>
      <div id="representative-fields" style="display:none; margin-top: 8px;">
        <label>
          Cédula del representante
          <input id="modal-parents_national_id" type="text" inputmode="numeric" />
        </label>
        <label>
          Nombre del representante
          <input id="modal-parents_first_name" type="text" />
        </label>
        <label>
          Apellido del representante
          <input id="modal-parents_last_name" type="text" />
        </label>
      </div>
      <label class="switch-line">
        <span>Activo</span>
        <input id="modal-is_active" type="checkbox" />
      </label>
    </div>
    <div class="modal-footer">
      <button id="modal-save" type="button" class="primary-button">Guardar</button>
    </div>
  <script src="user-table.js"></script>
  </div>
</body>

</html>